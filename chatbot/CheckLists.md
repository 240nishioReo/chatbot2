# 作業チェックリスト (CheckLists.md)
## Dify連携チャットボット開発タスク管理

### 📋 プロジェクト全体進捗

- [x] **Phase 1**: 環境構築・基盤システム (Week 1-2)
- [x] **Phase 2**: Dify API連携・ストリーミング実装 (Week 3)
- [x] **Phase 3**: 会話履歴管理機能 (Week 4)
- [x] **Phase 4**: レスポンス解析・UI/UX最適化 (Week 5)
- [ ] **Phase 5**: テスト・最終調整・ドキュメント (Week 6)

---

## 🔧 Phase 1: 環境構築・基盤システム

### 1.1 開発環境セットアップ
- [x] **conda環境作成**
  ```bash
  conda create -n chatbot python=3.12.9
  conda activate chatbot
  ```
- [x] **依存関係インストール**
  ```bash
  pip install Flask==2.3.3 Flask-SQLAlchemy==3.0.5 python-dotenv==1.0.0 requests==2.31.0
  ```
- [x] **requirements.txt作成・確認**
- [x] **.env ファイル作成**
  - [x] DIFY_API_BASE_URL設定
  - [x] DIFY_API_KEY_SAMPLE1/2/3 設定
  - [x] Flask設定値追加
- [x] **.gitignore設定**
  - [x] .envファイル除外
  - [x] データベースファイル除外
  - [x] __pycache__等除外

### 1.2 プロジェクト構造作成
- [x] **ディレクトリ構造構築**
  ```
  chatbot/
  ├── database/
  ├── static/css/
  ├── static/js/
  ├── templates/
  ├── utils/
  └── docs/
  ```
- [x] **空ファイル作成**
  - [x] `database/__init__.py`
  - [x] `utils/__init__.py`
  - [x] 各JSファイルの基本構造

### 1.3 データベース設計・実装
- [x] **SQLAlchemyモデル作成** (`database/models.py`)
  - [x] `DifyApp`モデル定義
  - [x] `Conversation`モデル定義
  - [x] `Message`モデル定義
  - [x] リレーションシップ設定
- [x] **データベース初期化スクリプト**
- [x] **初期データ投入**
  - [x] sample1/sample2/sample3 Difyアプリ登録
- [x] **インデックス設定**
  - [x] conversations.dify_app_id
  - [x] conversations.created_at
  - [x] messages.conversation_id

### 1.4 Flask基盤アプリケーション
- [x] **基本Flaskアプリ作成** (`app.py`)
  - [x] Flask初期化
  - [x] SQLAlchemy設定
  - [x] 環境変数読み込み
  - [x] ログ設定
- [x] **基本ルート定義**
  - [x] `/` (メイン画面)
  - [x] `/analysis/<message_id>` (解析画面)
- [x] **エラーハンドリング実装**
- [x] **データベース初期化処理**

---

## 🚀 Phase 2: Dify API連携・ストリーミング実装

### 2.1 Dify APIクライアント開発
- [x] **DifyClientクラス作成** (`utils/dify_client.py`)
  - [x] 認証ヘッダー設定
  - [x] ストリーミングリクエスト実装
  - [x] conversation_id管理
  - [x] エラーハンドリング
- [x] **ストリーミングパーサー実装**
  - [x] SSEデータ解析
  - [x] JSONデータ抽出
  - [x] message/message_endイベント処理
- [x] **APIキー動的切り替え機能**

### 2.2 ストリーミングチャットAPI
- [x] **`/api/chat-stream` エンドポイント実装**
  - [x] POSTリクエスト受信
  - [x] Difyアプリ選択処理
  - [x] 会話継続ロジック
  - [x] ユーザーメッセージ保存
  - [x] Difyストリーミング呼び出し
  - [x] アシスタントメッセージ保存
- [x] **Server-Sent Events 実装**
  - [x] 適切なヘッダー設定
  - [x] データストリーミング
  - [x] 接続エラー処理

### 2.3 基本フロントエンド実装
- [x] **メインHTML作成** (`templates/index.html`)
  - [x] ヘッダー・プルダウン・新規チャットボタン
  - [x] チャット表示エリア
  - [x] メッセージ入力フォーム
  - [x] 履歴サイドバー
- [x] **CSS基本スタイル** (`static/css/style.css`)
  - [x] レスポンシブレイアウト
  - [x] メッセージバブルデザイン
  - [x] ボタン・フォームスタイル
- [x] **基本JavaScript** (`static/js/main.js`)
  - [x] DOM初期化
  - [x] イベントリスナー設定
  - [x] 状態変数管理

### 2.4 リアルタイムチャット機能
- [x] **チャット機能実装** (`static/js/chat.js`)
  - [x] メッセージ送信機能
  - [x] EventSource/fetchストリーミング
  - [x] タイプライター効果実装
  - [x] マークダウンレンダリング (marked.js)
  - [x] conversation_id管理
- [x] **アプリ切り替え機能**
  - [x] プルダウン変更時のリセット
  - [x] 新規チャットボタン処理
- [x] **エラー表示・ローディング状態**

---

## 💾 Phase 3: 会話履歴管理機能

### 3.1 履歴管理API
- [x] **`/api/conversations` エンドポイント実装**
  - [x] GET: 会話一覧取得
  - [x] 最新順ソート
  - [x] タイトル自動生成
- [x] **`/api/conversations/<id>` エンドポイント実装**
  - [x] GET: 特定会話取得
  - [x] DELETE: 会話削除
- [ ] **検索機能実装**
  - [ ] タイトル・内容での絞り込み
  - [ ] 部分一致検索

### 3.2 履歴UI実装
- [x] **履歴表示機能** (`static/js/history.js`)
  - [x] 履歴一覧ロード
  - [x] 動的リスト更新
  - [x] 検索フィルタリング
- [x] **履歴操作機能**
  - [x] 会話選択・呼び出し
  - [x] 会話削除確認ダイアログ
  - [x] アクティブ履歴ハイライト
- [x] **履歴CSS改善**
  - [x] ホバーエフェクト
  - [x] アクションボタンスタイル

### 3.3 会話継続機能
- [x] **Dify conversation_id連携**
  - [x] 履歴選択時のID復元
  - [x] 新規会話時のIDリセット
  - [x] アプリ切り替え時のIDクリア
- [x] **会話状態管理**
  - [x] アクティブ会話表示
  - [x] 会話切り替え時のUI更新

---

## 🔍 Phase 4: レスポンス解析・UI/UX最適化

### 4.1 レスポンス解析機能
- [x] **ResponseParserクラス実装** (`utils/response_parser.py`)
  - [x] キーフレーズ抽出ロジック (`\r\n`分割)
  - [x] ソース文書整理
  - [x] 表示用データ整形
- [x] **解析API実装**
  - [x] `/api/messages/<id>/analysis` エンドポイント
  - [x] JSON・キーフレーズデータ返却
- [x] **解析ページHTML** (`templates/analysis.html`)
  - [x] RAW JSONデータ表示
  - [x] ソース文書分割表示
  - [x] キーフレーズ一覧表示

### 4.2 メッセージアクション機能
- [x] **メッセージ下部ボタン実装**
  - [x] 「ソースPDF表示」ボタン (未実装警告)
  - [x] 「レスポンス解析」ボタン (ページ遷移)
- [x] **解析ページJavaScript** (`static/js/analysis.js`)
  - [x] 解析データロード
  - [x] JSON整形表示
  - [x] キーフレーズハイライト

### 4.3 UI/UX最適化
- [x] **タイプライター効果改善**
  - [x] 文字間隔最適化 (50ms)
  - [x] スムーズな表示
  - [x] カーソル点滅エフェクト
- [x] **マークダウンプレビュー強化**
  - [x] コードブロックハイライト
  - [x] テーブル表示
  - [x] リンク処理
- [x] **レスポンシブ対応改善**
  - [x] モバイル・タブレット対応
  - [x] 可変レイアウト

### 4.4 パフォーマンス最適化
- [ ] **フロントエンド最適化**
  - [ ] 長いメッセージのレンダリング最適化
  - [ ] 履歴ロードの効率化
  - [ ] メモリリーク対策
- [ ] **バックエンド最適化**
  - [ ] データベースクエリ最適化
  - [ ] ストリーミング応答速度改善

---

## 🧪 Phase 5: テスト・最終調整・ドキュメント

### 5.1 機能テスト
- [x] **データベース初期設定修正**
  - [x] SQLiteファイルパス絶対パス化
  - [x] データベースディレクトリ自動作成機能追加
  - [x] データベースインデックス自動作成機能追加
  - [x] test_db.pyテストスクリプト作成
- [x] **基本機能テスト**
  - [x] SQLAlchemy 2.0対応修正完了
  - [x] アプリケーションコンテキスト問題修正
  - [x] jQuery読み込み問題修正（解析ページ）
  - [x] メッセージアクションボタン重複問題修正
  - [x] ストリーミングテキスト表示問題修正
  - [x] レスポンス解析ボタンSyntaxError修正
  - [x] アクションボタン位置修正（下部表示）
  - [x] 履歴呼び出し表示デバッグ強化
  - [x] 解析ページルート修正（UUID対応）
  - [x] メッセージID重複問題デバッグ強化
  - [ ] Difyアプリ切り替え動作確認
  - [ ] 新規チャット機能確認
  - [ ] 会話履歴保存・復元確認
  - [ ] メッセージ送受信確認
- [ ] **ストリーミング機能テスト**
  - [ ] タイプライター表示確認
  - [ ] conversation_id継続確認
  - [ ] エラー時の動作確認
- [ ] **レスポンス解析テスト**
  - [ ] キーフレーズ抽出確認
  - [ ] JSON表示確認
  - [ ] ページ遷移確認

### 5.2 統合テスト
- [ ] **Dify API連携テスト**
  - [ ] 全Difyアプリでの動作確認
  - [ ] APIキー切り替え確認
  - [ ] エラーハンドリング確認
- [ ] **データベース整合性テスト**
  - [ ] 会話・メッセージの正確な保存
  - [ ] 削除機能の動作確認
  - [ ] リレーション整合性確認
- [ ] **ブラウザ互換性テスト**
  - [ ] Chrome, Firefox, Edge対応確認
  - [ ] JavaScriptエラー確認

### 5.3 ユーザビリティテスト
- [ ] **操作性テスト**
  - [ ] 新規ユーザーでの操作テスト
  - [ ] 直感的な操作確認
  - [ ] エラーメッセージの分かりやすさ
- [ ] **パフォーマンステスト**
  - [ ] 応答速度測定
  - [ ] 長時間利用時の安定性
  - [ ] メモリ使用量確認

### 5.4 最終調整・ドキュメント
- [ ] **コード最終整理**
  - [ ] コメント追加・整理
  - [ ] 未使用コード削除
  - [ ] ファイル構成最終確認
- [ ] **ドキュメント完成**
  - [ ] README.md作成
  - [ ] インストール手順書
  - [ ] API仕様書
  - [ ] トラブルシューティングガイド
- [ ] **デプロイ準備**
  - [ ] 本番環境設定
  - [ ] セキュリティ設定確認

---

## 🚨 重要な注意事項・検証ポイント

### ⚠️ 必須確認事項
- [ ] **Difyアプリ切り替え時の会話リセット**
  - プルダウン変更時にチャット画面が完全にクリアされること
  - conversation_idが確実にnullにリセットされること
- [ ] **新規チャット時の会話リセット**  
  - 「新規チャット」ボタンクリック時の完全リセット
  - 履歴の非アクティブ化
- [ ] **ストリーミングでのブロッキング回避**
  - Dify APIをstreaming modeでのみ使用
  - ブロッキング通信は絶対に使用しない
- [ ] **conversation_id管理の整合性**
  - Dify側とDB側のconversation_idの同期
  - 履歴呼び出し時の正確な復元

### 🔍 品質保証チェックリスト
- [ ] **コードのクリーンさ**
  - [ ] DRY原則の遵守
  - [ ] 適切なエラーハンドリング
  - [ ] ログ出力の適切さ
- [ ] **セキュリティ**
  - [ ] APIキーの適切な管理
  - [ ] SQLインジェクション対策
  - [ ] XSS対策
- [ ] **パフォーマンス**
  - [ ] データベースインデックス設定
  - [ ] 不要なAPIコール削減
  - [ ] メモリリーク対策

### 📊 進捗追跡・報告

#### 日次チェック項目
- [ ] 今日完了予定タスクの達成状況
- [ ] 明日の作業予定の明確化
- [ ] 発生した技術課題・解決策の記録

#### 週次レビュー項目
- [ ] Phase完了率の確認
- [ ] 品質・要件との整合性確認
- [ ] スケジュール調整の必要性判断

#### 最終デリバリ前確認
- [ ] 全機能要件の100%実装完了
- [ ] 非機能要件（性能・UX）の達成
- [ ] ドキュメント完成度の確認
- [ ] 本番環境デプロイ準備完了

---

## 🛠️ 開発効率化Tips

### ⚡ 開発スピードアップ技法
1. **コード生成活用**: SQLAlchemyモデル、APIエンドポイントのボイラープレートを効率化
2. **段階的実装**: 最初はハードコードで動作確認、後で設定可能化
3. **モックアップ先行**: フロントエンドをモックデータで先に完成させる
4. **ログ活用**: 各段階で詳細ログを出力し、デバッグを効率化

### 🎯 優先度付け指針
1. **必須**: Difyストリーミング連携、会話履歴継続、アプリ切り替え
2. **重要**: タイプライター表示、マークダウンプレビュー、検索機能
3. **推奨**: レスポンス解析、UI最適化、エラーハンドリング強化

### 🔄 反復開発アプローチ
- **Sprint 1**: 最小動作版 (基本チャット)
- **Sprint 2**: 履歴・継続機能追加
- **Sprint 3**: 解析・UI/UX完成
- **Sprint 4**: 最終調整・品質向上

このチェックリストを使用して、確実かつ効率的にDify連携チャットボットアプリケーションを完成させてください。各チェック項目は、実装完了時に☑️にマークし、プロジェクトの進捗を可視化してください。
