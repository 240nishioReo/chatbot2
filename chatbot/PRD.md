# プロダクト要求仕様書 (PRD)
## Dify連携チャットボット・ウェブアプリケーション

### 1. プロダクト概要

#### 1.1 プロダクト名
**Dify Chat Interface** - 複数Difyアプリケーション統合チャットボットシステム

#### 1.2 プロダクトビジョン
Dify APIを活用し、複数のAIアプリケーションを統一されたインターフェースで利用できる、高性能かつ直感的なチャットボット・ウェブアプリケーションを提供する。

#### 1.3 プロダクト背景・目的
- 複数のDifyアプリケーションを効率的に切り替えながら利用したいニーズに対応
- ストリーミング形式による低遅延・高UXなチャット体験の実現
- 会話履歴の永続化と検索・管理機能による生産性向上
- 将来的なPDF文書検索・表示機能への拡張基盤の構築

### 2. ターゲットユーザー

#### 2.1 プライマリーユーザー
- **研究者・アナリスト**: 複数のAIモデルを比較検討しながら情報収集・分析を行う
- **ナレッジワーカー**: 日常業務で異なる特性を持つAIアシスタントを使い分ける
- **開発者**: Dify APIの機能検証・プロトタイピングを行う

#### 2.2 利用シナリオ
1. **マルチモデル比較**: 同じ質問を複数のDifyアプリに投げて回答品質を比較
2. **タスク別AI活用**: 文書要約用AI、コード生成用AI、分析用AIなど用途別に切り替え
3. **長期プロジェクト管理**: 会話履歴を検索・再利用しながら継続的な作業を実施

### 3. 機能要件

#### 3.1 コア機能

##### 3.1.1 Difyアプリケーション選択機能
- **プルダウンメニュー**: ページ上部に配置、初期値sample1/sample2/sample3
- **動的APIキー切り替え**: 選択されたアプリに応じて`.env`ファイルから対応するAPIキーを動的読み込み
- **アプリ切り替え時の動作**: 選択変更時にチャット画面を自動リセット、新しい`conversation_id`で開始

##### 3.1.2 リアルタイム・ストリーミングチャット機能
- **ストリーミング通信**: Dify APIをストリーミングモードで呼び出し、ブロッキングを完全回避
- **タイプライター表示**: 受信データを1文字ずつスムーズに表示、最高レベルのUX実現
- **マークダウンプレビュー**: ボット返信をリアルタイムでマークダウン形式にレンダリング
- **会話継続**: `conversation_id`による文脈保持機能

##### 3.1.3 会話セッション管理機能
- **新規チャットボタン**: クリック時にチャット画面リセット、新しい会話セッション開始
- **自動保存**: 会話内容とDify `conversation_id`をデータベースに自動保存
- **セッション識別**: ユニークな会話IDによる各セッションの識別・管理

##### 3.1.4 会話履歴管理機能
- **履歴一覧表示**: 右サイドバーに過去の会話セッション一覧を表示
- **履歴検索機能**: タイトルまたは内容による履歴検索
- **履歴削除機能**: 不要な会話履歴の削除
- **履歴呼び出し機能**: 選択した履歴の会話を復元、Dify側でも同じ`conversation_id`で継続

#### 3.2 高度な機能

##### 3.2.1 レスポンス分析機能
- **ソースPDF表示ボタン**: 各ボット返信下部に配置（現段階では未実装、将来拡張予定の旨を表示）
- **レスポンス解析ボタン**: クリック時に専用分析ページへ遷移
- **JSON表示**: DifyレスポンスのRAW JSONデータを整形して表示
- **キーフレーズ抽出**: レスポンス内の回答生成文書から`\r\n`区切りでキーフレーズを自動抽出・表示

##### 3.2.2 レスポンス解析ページ
- **構造化表示**: 回答生成に使用された元文書（通常3つ）とそこから抽出されたキーフレーズを明確に区分して表示
- **将来拡張準備**: PDF検索・ハイライト機能の実装準備として、キーフレーズとメタデータを構造化

### 4. 非機能要件

#### 4.1 パフォーマンス要件
- **レスポンス時間**: チャット送信からストリーミング開始まで500ms以内
- **タイプライター表示**: 50ms間隔での文字表示により自然な読字体験
- **同時接続**: 最低10セッションの同時利用をサポート

#### 4.2 ユーザビリティ要件
- **直感的操作**: 新規ユーザーが説明なしで基本操作を理解可能
- **レスポンシブ対応**: デスクトップ環境での最適化（モバイル対応は将来スコープ）
- **視覚的フィードバック**: ローディング状態、送信中状態の明確な表示

#### 4.3 技術要件
- **フレームワーク**: Flask (Python) バックエンド
- **フロントエンド**: バニラJavaScript + jQuery (CDN)
- **データベース**: SQLite による軽量・高速なローカルストレージ
- **環境管理**: conda環境による依存関係の明確化
- **設定管理**: `.env`ファイルによる機密情報の安全な管理

#### 4.4 セキュリティ要件
- **APIキー保護**: `.env`ファイルによるAPIキーの暗号化・隠蔽
- **入力検証**: チャット入力に対する適切なサニタイゼーション
- **レート制限**: Dify API呼び出し回数の適切な制御

### 5. 技術仕様概要

#### 5.1 システム構成
```
Frontend (HTML/CSS/JS) ←→ Flask API ←→ SQLite DB
                                ↓
                           Dify API (Streaming)
```

#### 5.2 主要技術スタック
- **Backend**: Flask, SQLAlchemy, python-dotenv
- **Frontend**: HTML5, CSS3, JavaScript ES6+, jQuery, marked.js
- **Database**: SQLite with proper indexing
- **Environment**: conda, pip requirements.txt
- **External APIs**: Dify API (streaming mode)

#### 5.3 データベース設計概要
- `dify_apps`: Difyアプリケーション管理テーブル
- `conversations`: 会話セッション管理テーブル  
- `messages`: 個別メッセージ保存テーブル

### 6. スコープと制約

#### 6.1 現在のスコープ（v1.0）
✅ Dify API連携によるストリーミングチャット  
✅ 複数Difyアプリケーション切り替え機能  
✅ 会話履歴管理（保存・検索・削除・呼び出し）  
✅ レスポンス解析機能（JSON表示・キーフレーズ抽出）  
✅ タイプライターエフェクト  
✅ マークダウンプレビュー  

#### 6.2 将来スコープ（v2.0以降）
🔄 PDF文書検索・ハイライト表示機能  
🔄 マルチユーザー対応  
🔄 モバイル・レスポンシブ対応  
🔄 会話履歴のエクスポート・インポート機能  
🔄 カスタムDifyアプリ追加機能  

#### 6.3 技術的制約
- **ローカル環境限定**: 初期版はローカル開発環境での利用を想定
- **同期処理**: 複数ユーザーの同時編集は未対応
- **ファイルサイズ**: 履歴保存は軽量テキストのみ、大容量ファイル未対応

### 7. 成功指標・KPI

#### 7.1 機能的成功指標
- **応答成功率**: 99%以上のDify API連携成功率
- **データ整合性**: 会話履歴の100%正確な保存・復元
- **アプリ切り替え**: エラーなく瞬時にDifyアプリケーション切り替え

#### 7.2 UX成功指標
- **タイプライター表示**: ユーザーが「自然で読みやすい」と感じる表示速度
- **直感的操作**: 新規ユーザーの90%が5分以内に基本操作をマスター
- **履歴検索**: 目的の会話を30秒以内で発見可能

### 8. リリース計画

#### 8.1 開発フェーズ
1. **Phase 1** (Week 1-2): 基盤システム構築（Flask + DB + 基本UI）
2. **Phase 2** (Week 3): Dify API連携 + ストリーミング実装
3. **Phase 3** (Week 4): 会話履歴機能 + 検索機能
4. **Phase 4** (Week 5): レスポンス解析機能 + UI/UX最適化
5. **Phase 5** (Week 6): テスト + ドキュメント + デプロイ準備

#### 8.2 検証・テスト計画
- **単体テスト**: 各APIエンドポイントの動作確認
- **統合テスト**: Dify API連携の安定性検証
- **ユーザビリティテスト**: 実際のワークフロー通りの操作テスト

この仕様書に基づき、次の実装設計書で技術的詳細を具体化していきます。
